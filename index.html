<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>N√úA Smart Performance</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 24px;
        }

        .subtitle {
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 30px;
            font-size: 14px;
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .card h2 {
            margin: 0 0 16px 0;
            font-size: 18px;
            color: #227c9d;
        }

        /* --- UI Components --- */
        .btn {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: #227c9d;
            color: white;
        }

        .btn-primary:hover {
            background: #1a627d;
            transform: translateY(-2px);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-primary:disabled {
            background: #444;
            color: #888;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            text-align: center;
            padding: 12px;
            border-radius: 8px;
            margin-top: 16px;
            display: none;
            font-size: 14px;
        }

        .status.show {
            display: block;
        }

        .status.success {
            background: rgba(34, 124, 157, 0.2);
            color: #227c9d;
        }

        .status.error {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .status.loading {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        /* --- PIN Login Screen --- */
        .login-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80vh;
        }

        .login-logo-img {
            width: 160px;
            height: auto;
            margin-bottom: 16px;
            filter: drop-shadow(0 4px 12px rgba(34, 124, 157, 0.4));
        }

        .login-title {
            font-size: 28px;
            font-weight: 900;
            margin-bottom: 4px;
            text-align: center;
        }

        .login-title span {
            color: #227c9d;
        }

        .login-subtitle {
            color: rgba(255, 255, 255, 0.5);
            font-size: 14px;
            margin-bottom: 28px;
        }

        .pin-dots {
            display: flex;
            gap: 12px;
            margin-bottom: 28px;
        }

        .pin-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
            transition: all 0.2s;
        }

        .pin-dot.filled {
            background: #227c9d;
            border-color: #227c9d;
        }

        .pin-dot.error {
            background: #ef4444;
            border-color: #ef4444;
            animation: shake 0.4s;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-6px);
            }

            75% {
                transform: translateX(6px);
            }
        }

        .pin-pad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            max-width: 300px;
            width: 100%;
            margin-bottom: 28px;
        }

        .pin-key {
            aspect-ratio: 1;
            border: 2px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pin-key:active {
            transform: scale(0.95);
            background: rgba(34, 124, 157, 0.3);
        }

        .pin-key.action {
            font-size: 16px;
            color: #227c9d;
        }

        .pin-key.delete {
            color: #ef4444;
            font-size: 16px;
            border-color: rgba(239, 68, 68, 0.3);
        }

        /* --- Mode Selector --- */
        .mode-selector {
            display: none;
            flex-direction: column;
            gap: 16px;
            min-height: 70vh;
            justify-content: center;
        }

        .mode-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            display: flex;
            align-items: center;
            gap: 20px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .mode-card:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: #227c9d;
            transform: translateY(-3px);
        }

        .mode-card .icon {
            font-size: 40px;
        }

        .mode-card .info h3 {
            margin: 0;
            font-size: 20px;
        }

        .mode-card .info p {
            margin: 5px 0 0 0;
            font-size: 13px;
            color: rgba(255, 255, 255, 0.5);
        }

        /* --- App Screens --- */
        .app-screen {
            display: none;
        }

        .header-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .header-row h1 {
            font-size: 20px;
            margin: 0;
        }

        .role-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .role-badge.admin {
            background: rgba(34, 124, 157, 0.2);
            color: #227c9d;
        }

        .role-badge.camarero {
            background: rgba(168, 85, 247, 0.2);
            color: #a855f7;
        }

        /* Performance Show styles */
        .quick-videos {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 16px;
        }

        .video-card {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .video-card.selected {
            border-color: #227c9d;
            background: rgba(34, 124, 157, 0.2);
        }

        .video-card img {
            width: 100%;
            aspect-ratio: 16/9;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .video-card .name {
            font-size: 11px;
            font-weight: 600;
            line-height: 1.2;
            height: 2.4em;
            overflow: hidden;
        }

        .more-videos-container {
            margin-top: 15px;
        }

        .more-videos-toggle {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: white;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
        }

        .more-videos-dropdown {
            display: none;
            margin-top: 10px;
            max-height: 300px;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .more-videos-dropdown.show {
            display: grid;
        }

        .mesas-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
        }

        .mesa-btn {
            aspect-ratio: 1;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-weight: bold;
            cursor: pointer;
        }

        .mesa-btn.selected {
            background: #227c9d;
            border-color: #227c9d;
        }

        /* Restaurant Mode Styles */
        .menu-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .menu-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(0, 0, 0, 0.2);
            padding: 16px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .menu-info h4 {
            margin: 0;
            font-size: 15px;
        }

        .menu-info p {
            margin: 4px 0 0 0;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
        }

        /* Toggle Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.2);
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #227c9d;
        }

        input:checked+.slider:before {
            transform: translateX(24px);
        }

        .back-btn {
            background: none;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.6);
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
        }

        .logout-btn {
            background: none;
            border: none;
            color: #ef4444;
            font-size: 12px;
            cursor: pointer;
            margin-top: 20px;
            opacity: 0.7;
        }

        /* --- Schedule UI --- */
        .day-btn {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.6);
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .day-btn.selected {
            background: #227c9d;
            border-color: #227c9d;
            color: white;
        }

        .schedule-rule {
            background: rgba(0, 0, 0, 0.2);
            padding: 14px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            margin-bottom: 10px;
        }

        .schedule-rule .rule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .schedule-rule .rule-label {
            font-weight: 600;
            font-size: 15px;
        }

        .rule-time {
            color: #227c9d;
            font-weight: 600;
            font-size: 15px;
        }

        .rule-days {
            display: flex;
            gap: 4px;
            margin-top: 6px;
        }

        .rule-day {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
        }

        .rule-day.active {
            background: rgba(34, 124, 157, 0.3);
            color: #227c9d;
        }

        .rule-day.inactive {
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.2);
        }

        .rule-delete {
            background: none;
            border: none;
            color: #ef4444;
            cursor: pointer;
            font-size: 18px;
            padding: 4px 8px;
        }

        .schedule-form {
            margin-top: 16px;
            background: rgba(0, 0, 0, 0.3);
            padding: 16px;
            border-radius: 12px;
        }

        .schedule-form label {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.7);
            display: block;
            margin-bottom: 4px;
        }

        .schedule-form input[type="text"],
        .schedule-form input[type="time"] {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 14px;
            box-sizing: border-box;
        }

        .form-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .form-row > div {
            flex: 1;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- 1. LOGIN SCREEN -->
        <div class="login-screen" id="loginScreen">
            <img class="login-logo-img" src="https://hebbkx1anhila5yf.public.blob.vercel-storage.com/design-mode-images/6-mmrunB56i4GoJH3sF4av0M9rRmawsK.png" alt="Smart Table">
            <div class="login-title">N√úA <span>SMART PERFORMANCE</span></div>
            <div class="login-subtitle">Introduce tu PIN</div>
            <div class="pin-dots" id="pinDots">
                <div class="pin-dot"></div>
                <div class="pin-dot"></div>
                <div class="pin-dot"></div>
                <div class="pin-dot"></div>
            </div>
            <div class="pin-pad">
                <script>
                    for (var i = 1; i <= 9; i++) document.write('<button class="pin-key" onclick="pinPress(\'' + i + '\')">' + i + '</button>');
                </script>
                <button class="pin-key action" onclick="pinClear()">C</button>
                <button class="pin-key" onclick="pinPress('0')">0</button>
                <button class="pin-key delete" onclick="pinDelete()">DEL</button>
            </div>
        </div>

        <!-- 2. MODE SELECTOR -->
        <div class="mode-selector" id="modeSelector">
            <h1 id="welcomeUser">Bienvenido</h1>
            <div class="mode-card" onclick="enterMode('performance')">
                <div class="icon">üé¨</div>
                <div class="info">
                    <h3>Performance Show</h3>
                    <p>Control de v√≠deos en mesas</p>
                </div>
            </div>
            <div class="mode-card" id="restaurantModeCard" onclick="enterMode('restaurant')">
                <div class="icon">üç¥</div>
                <div class="info">
                    <h3>Restaurant Control</h3>
                    <p>Gesti√≥n de men√∫s y cartas</p>
                </div>
            </div>
            <center><button class="logout-btn" onclick="logout()">Cerrar Sesi√≥n</button></center>
        </div>

        <!-- 3. PERFORMANCE SHOW SCREEN -->
        <div class="app-screen" id="performanceScreen">
            <div class="header-row">
                <button class="back-btn" onclick="showModeSelector()">‚Üê Volver</button>
                <h1>Performance</h1>
                <span id="roleBadgePerf" class="role-badge"></span>
            </div>

            <div class="card">
                <h2>Selecciona Video</h2>
                <div class="quick-videos" id="quickVideos"></div>
                <div class="more-videos-container" id="moreVideosContainer">
                    <button class="more-videos-toggle" onclick="toggleMoreVideos()">
                        <span>M√°s v√≠deos...</span><span>‚ñº</span>
                    </button>
                    <div class="more-videos-dropdown" id="moreVideosDropdown"></div>
                </div>
            </div>

            <div class="card">
                <h2>Selecciona Mesas</h2>
                <div class="quick-actions" style="display:flex; gap:5px; margin-bottom:10px;">
                    <button class="back-btn" style="flex:1" onclick="selectRange(1,18)">Todas</button>
                    <button class="back-btn" style="flex:1" onclick="selectNone()">Ninguna</button>
                </div>
                <div class="mesas-grid" id="mesasGrid"></div>
            </div>

            <div class="card">
                <button class="btn btn-primary" id="publishBtn" onclick="publish()" disabled>üöÄ PUBLICAR</button>
                <div id="statusPub" class="status"></div>
            </div>
        </div>

        <!-- 4. RESTAURANT SCREEN -->
        <div class="app-screen" id="restaurantScreen">
            <div class="header-row">
                <button class="back-btn" onclick="showModeSelector()">‚Üê Volver</button>
                <h1>Restaurant</h1>
                <span id="roleBadgeRest" class="role-badge"></span>
            </div>

            <div class="card">
                <h2>Smart Men√∫s</h2>
                <div class="menu-list" id="menuList">
                    <!-- Men√∫s cargados por JS -->
                </div>
                <div id="statusRest" class="status"></div>
            </div>

            <!-- SCHEDULE CARD (Admin only) -->
            <div class="card" id="scheduleCard" style="display:none">
                <h2>Programacion Horaria</h2>
                <p style="color:rgba(255,255,255,0.5);font-size:13px;margin:0 0 16px 0">
                    Activa/desactiva menus automaticamente por dia y hora
                </p>

                <!-- Global on/off -->
                <div class="menu-item" style="margin-bottom:16px">
                    <div class="menu-info">
                        <h4>Programacion activa</h4>
                        <p id="scheduleStatus">Cargando...</p>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="scheduleEnabled" onchange="toggleScheduleEnabled()">
                        <span class="slider"></span>
                    </label>
                </div>

                <!-- Rules list -->
                <div id="scheduleRules"></div>

                <!-- Add rule button -->
                <button class="btn btn-primary" style="margin-top:12px;padding:12px;font-size:14px"
                        onclick="showAddRuleForm()">
                    + Anadir Regla
                </button>

                <!-- Add rule form (hidden) -->
                <div id="ruleForm" class="schedule-form" style="display:none">
                    <h4 style="margin:0 0 12px 0;font-size:16px">Nueva Regla</h4>

                    <div style="margin-bottom:12px">
                        <label>Nombre</label>
                        <input type="text" id="ruleName" placeholder="Ej: Menus Mediodia">
                    </div>

                    <div style="margin-bottom:12px">
                        <label>Dias</label>
                        <div id="daySelector" style="display:flex;gap:6px;margin-top:6px;flex-wrap:wrap"></div>
                    </div>

                    <div class="form-row">
                        <div>
                            <label>Hora inicio</label>
                            <input type="time" id="ruleStartTime" value="12:00">
                        </div>
                        <div>
                            <label>Hora fin</label>
                            <input type="time" id="ruleEndTime" value="15:30">
                        </div>
                    </div>

                    <div style="display:flex;gap:8px;margin-top:12px">
                        <button class="btn btn-primary" style="padding:10px;font-size:14px" onclick="saveRule()">Guardar</button>
                        <button class="back-btn" style="flex:1;padding:10px" onclick="cancelRuleForm()">Cancelar</button>
                    </div>
                </div>

                <div id="statusSchedule" class="status" style="margin-top:12px"></div>
            </div>
        </div>
    </div>

    <script>
        var THUMB_URL = "https://dotykpreviews.blob.core.windows.net/thumbnails/";
        var QUICK_VIDEOS = [
            { id: "1qfl_FzhVSQfWSsQ6uBLxswJV9x4_BbeV22KojBIMOwxJAD4CGPWPwFnFf8m", name: "CUMPLE GENERAL", thumb: "MdjRFpTGos3v0r9IwudhttkFbsLwo-3dgvEtkUuM" },
            { id: "3qIll9Wlan7lvnHmGHCHfkCFccbd6YLqtoxDAi3CHanj4ZMNYgcAD2vxBtMd", name: "TIEMPO AGOTADO", thumb: "8voUMETpAmmpoeAHKSt7vmiwLfEQRB32CdSXAvJU" },
            { id: "Sa1XOxcY_ytPez8aein6Hy4YLWYxeLuqSF1SG43hFQ_ivKK1P_pErXcRLf37", name: "VOLUMEN ELEVADO", thumb: "vSyIvV9ZxLcyuG5bEnL3GEu_yGqu_zq6-Lqhg03Z" },
            { id: "WxLLkbKYsA2uLjVvvhhDG8dgypnPotBB0qN1zqvNHK2CLB1mAi6WLv8OUfm3", name: "RETRASOS", thumb: "oBnZzcmE7OP3j5NfYVYBYPfAqK5ZvxBMEhwu7CxR" },
            { id: "SuGs0x4OaOzF_W9AIi_OYr7OVm2EsUf39u_HmiGDG3Wze0kZJCLQbgAYoGlp", name: "SHHHHH", thumb: "FG4SHRXXxmimmylzr8qIKxVMRRF6xhMIta78XJOP" }
        ];
        var MORE_VIDEOS = [
            { id: "4RwbgS0krw8W4MUCaatGs4mltolJYa7qO2jpgVtIb-YeTswBGwnnx1WWx3zB", name: "CUMPLE NUA", thumb: "MvyfU-hu4AmAj4-ka9aHrRJ0v3uwhJC1VX6N88hW" },
            { id: "32dg9T2c4VDdgz911Ont8-7KCivXhaAtWY_qqEbBdmpntgvZ-183MOXKQXo5", name: "Simulacion juego", thumb: "CIMXPqkRDOaZXUbd07VBW2M25JbpNyq0xBKqNcsm" },
            { id: "QHdpsxolVKtBKrvI3GRMELI6YCuFWk4RlkoIOPExlR8q3KwfOX-8DBvZODAi", name: "SCREAM", thumb: "4oEzc4mDMEpUQAVxkkztHjImppSbRZnHAw6AXEJw" },
            { id: "y4_Oc92qpCLg30XkrrRpEMdz7Kepy9WRAXJEA9RQI5qskmjwqG4yMLwEbXkp", name: "FREDDY", thumb: "IAO7hV5ppQ2foBsAU6TIpxqVh9ZZfi1-fhoQ_sO2" },
            { id: "foMwA4gNRlWtBOb32bvSokNNhWwcGIoNaDcQmq1Y2l48qU9Gfw4s-mvWYRfZ", name: "SIERRA SCREAM", thumb: "IDM-3miCLhbiJ_L6DjxBZIYJMSj34GSWJ_13NtPE" },
            { id: "FcyXBaU-VbDnpQ1prcngwKQnTqrmlcOoFR3_bfc_Zs2307XyzKq7CUvrhRLS", name: "SILLA EXORCISTA", thumb: "VrfuZwnDrHJBAmiA0ofk7nVC6oQzQZDgJzYU0rOJ" }
        ];
        var SMART_MENU_CATEGORY = { id: "7037dd01-8e70-4571-8857-6295f01c8862", name: "Smart Men√∫s" };
        var RESTAURANT_MENUS = [
            { id: "7b2ed65e-05c9-45b9-b7b9-adc83345cd5b", name: "Smart Men√∫: Poke edition" },
            { id: "a61bbcb4-6efe-4be7-85f1-2d6c84adf564", name: "Smart Men√∫: Burger edition" },
            { id: "782e61b7-9cc9-48e2-b5be-b78876692929", name: "Crea tu Smart Men√∫" },
            { id: "338712fd-f2a9-463e-8532-6fa17c7ebe8e", name: "Smart Love Men√∫" },
            { id: "4c394f20-e562-4ed5-aa2b-fa7a3ffbbc18", name: "Smart Men√∫: Business Edition" }
        ];
        var MESAS = [
            { id: 239, name: "1" }, { id: 240, name: "2" }, { id: 241, name: "3" },
            { id: 235, name: "4" }, { id: 227, name: "5" }, { id: 229, name: "6" },
            { id: 225, name: "7" }, { id: 231, name: "8" }, { id: 234, name: "9" },
            { id: 228, name: "10" }, { id: 226, name: "11" }, { id: 222, name: "12" },
            { id: 223, name: "13" }, { id: 230, name: "14" }, { id: 224, name: "15" },
            { id: 237, name: "16" }, { id: 342, name: "17" }, { id: 356, name: "18" }
        ];

        var currentPin = "";
        var currentRole = null;
        var selectedVideo = null;
        var selectedMesas = new Set();

        // 1. PIN LOGIC
        function pinPress(d) {
            if (currentPin.length < 4) { currentPin += d; updatePinDots(); if (currentPin.length == 4) validate(); }
        }
        function pinDelete() { currentPin = currentPin.slice(0, -1); updatePinDots(); }
        function pinClear() { currentPin = ""; updatePinDots(); }
        function updatePinDots() {
            var dots = document.querySelectorAll('.pin-dot');
            for (var i = 0; i < 4; i++) dots[i].className = 'pin-dot' + (i < currentPin.length ? ' filled' : '');
        }
        function validate() {
            var roles = { "2020": "camarero", "9069": "admin" };
            var role = roles[currentPin];
            if (role) {
                currentRole = role;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('modeSelector').style.display = 'flex';
                document.getElementById('welcomeUser').textContent = 'Bienvenido, ' + (role == 'admin' ? 'Admin' : 'Equipo');
                initApp();
            } else {
                document.querySelectorAll('.pin-dot').forEach(function (d) { d.classList.add('error'); });
                setTimeout(pinClear, 500);
            }
        }

        // 2. NAVIGATION
        function enterMode(mode) {
            document.getElementById('modeSelector').style.display = 'none';
            document.getElementById(mode + 'Screen').style.display = 'block';
        }
        function showModeSelector() {
            document.querySelectorAll('.app-screen').forEach(function (s) { s.style.display = 'none'; });
            document.getElementById('modeSelector').style.display = 'flex';
        }
        function logout() { location.reload(); }

        // 3. APP INIT
        function initApp() {
            // Apply role badges
            var badgeText = currentRole == 'admin' ? 'Admin' : 'Camarero';
            var badgeClass = 'role-badge ' + currentRole;
            document.getElementById('roleBadgePerf').textContent = badgeText;
            document.getElementById('roleBadgePerf').className = badgeClass;
            document.getElementById('roleBadgeRest').textContent = badgeText;
            document.getElementById('roleBadgeRest').className = badgeClass;

            // Restrict "More videos" for camareros
            if (currentRole == 'camarero') document.getElementById('moreVideosContainer').style.display = 'none';

            renderPerformance();
            renderRestaurant();

            // Show schedule card only for admin
            if (currentRole === 'admin') {
                document.getElementById('scheduleCard').style.display = 'block';
                loadSchedule();
            }
        }

        function renderPerformance() {
            var qGrid = document.getElementById('quickVideos');
            qGrid.innerHTML = QUICK_VIDEOS.map(function (v) {
                return '<div class="video-card" onclick="selV(\'' + v.id + '\')"><img src="' + THUMB_URL + v.thumb + '"><div class="name">' + v.name + '</div></div>';
            }).join('');

            var mGrid = document.getElementById('moreVideosDropdown');
            mGrid.innerHTML = MORE_VIDEOS.map(function (v) {
                return '<div class="video-card" onclick="selV(\'' + v.id + '\')"><img src="' + THUMB_URL + v.thumb + '"><div class="name">' + v.name + '</div></div>';
            }).join('');

            var mGridMesas = document.getElementById('mesasGrid');
            mGridMesas.innerHTML = MESAS.map(function (m) {
                return '<button class="mesa-btn" data-id="' + m.id + '" onclick="toggleMesa(' + m.id + ')">' + m.name + '</button>';
            }).join('');
        }

        function renderRestaurant() {
            var list = document.getElementById('menuList');
            // Categor√≠a padre (toggle principal)
            var html = '<div class="menu-item" style="background:rgba(34,124,157,0.15);border:1px solid rgba(34,124,157,0.3)">' +
                '<div class="menu-info"><h4 style="font-size:17px">üìÇ ' + SMART_MENU_CATEGORY.name + '</h4><p>Categor√≠a principal</p></div>' +
                '<label class="switch"><input type="checkbox" onchange="toggleMenu(\'' + SMART_MENU_CATEGORY.id + '\', this.checked)"><span class="slider"></span></label></div>';
            // Separator
            html += '<div style="border-top:1px solid rgba(255,255,255,0.1);margin:4px 0"></div>';
            // Men√∫s hijos
            html += RESTAURANT_MENUS.map(function (m) {
                return '<div class="menu-item" style="margin-left:12px"><div class="menu-info"><h4>' + m.name + '</h4><p>ID: ...' + m.id.slice(-8) + '</p></div>' +
                    '<label class="switch"><input type="checkbox" onchange="toggleMenu(\'' + m.id + '\', this.checked)"><span class="slider"></span></label></div>';
            }).join('');
            list.innerHTML = html;
        }

        // 4. FUNCTIONALITY
        function selV(id) {
            selectedVideo = id;
            document.querySelectorAll('.video-card').forEach(function (c) { c.classList.remove('selected'); });
            event.currentTarget.classList.add('selected');
            document.getElementById('publishBtn').disabled = false;
        }

        function toggleMesa(id) {
            if (selectedMesas.has(id)) selectedMesas.delete(id); else selectedMesas.add(id);
            document.querySelectorAll('.mesa-btn').forEach(function (b) {
                b.classList.toggle('selected', selectedMesas.has(parseInt(b.dataset.id)));
            });
        }

        function selectRange(s, e) {
            MESAS.forEach(function (m) { if (parseInt(m.name) >= s && parseInt(m.name) <= e) selectedMesas.add(m.id); });
            toggleMesa(null);
        }

        function selectNone() { selectedMesas.clear(); toggleMesa(null); }

        function toggleMoreVideos() { document.getElementById('moreVideosDropdown').classList.toggle('show'); }

        async function publish() {
            var btn = document.getElementById('publishBtn');
            var status = document.getElementById('statusPub');
            btn.disabled = true;
            status.textContent = "Publicando..."; status.className = "status show loading";

            try {
                var res = await fetch('/api/publish', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tables: Array.from(selectedMesas), videoUrl: "https://irtperformanceshoweu.blob.core.windows.net/dotykcloudperformanceshow/" + selectedVideo })
                });
                var data = await res.json();
                if (data.success) {
                    status.textContent = "‚úÖ ¬°Publicado!"; status.className = "status show success";
                } else throw new Error(data.error);
            } catch (e) {
                status.textContent = "‚ùå Error: " + e.message; status.className = "status show error";
            }
            btn.disabled = false;
        }

        // ========== SCHEDULE FUNCTIONS ==========
        var DAY_NAMES = ['L', 'M', 'X', 'J', 'V', 'S', 'D'];
        var DAY_FULL = ['Lunes', 'Martes', 'Miercoles', 'Jueves', 'Viernes', 'Sabado', 'Domingo'];
        var currentSchedule = { enabled: false, rules: [], lastAction: null, lastCronRun: null };
        var selectedDays = new Set();

        async function loadSchedule() {
            try {
                var res = await fetch('/api/schedule');
                var data = await res.json();
                currentSchedule = data;
                renderSchedule();
            } catch (e) {
                document.getElementById('scheduleStatus').textContent = 'Error al cargar';
            }
        }

        function renderSchedule() {
            // Update global toggle
            document.getElementById('scheduleEnabled').checked = currentSchedule.enabled;
            var statusText = currentSchedule.enabled ? 'Activada' : 'Desactivada';
            if (currentSchedule.lastCronRun) {
                statusText += ' ¬∑ Ultimo cron: ' + currentSchedule.lastCronRun;
            }
            document.getElementById('scheduleStatus').textContent = statusText;

            // Render rules
            var container = document.getElementById('scheduleRules');
            if (!currentSchedule.rules || currentSchedule.rules.length === 0) {
                container.innerHTML = '<p style="color:rgba(255,255,255,0.4);font-size:13px;text-align:center;padding:12px 0">No hay reglas configuradas</p>';
                return;
            }
            container.innerHTML = currentSchedule.rules.map(function (rule) {
                var daysHtml = DAY_NAMES.map(function (d, i) {
                    var active = rule.days && rule.days.indexOf(i) !== -1;
                    return '<div class="rule-day ' + (active ? 'active' : 'inactive') + '">' + d + '</div>';
                }).join('');
                return '<div class="schedule-rule">' +
                    '<div class="rule-header">' +
                    '<span class="rule-label">' + (rule.label || 'Regla') + '</span>' +
                    '<div style="display:flex;align-items:center;gap:8px">' +
                    '<span class="rule-time">' + (rule.startTime || '') + ' - ' + (rule.endTime || '') + '</span>' +
                    '<button class="rule-delete" onclick="deleteRule(\'' + rule.id + '\')" title="Eliminar">‚úï</button>' +
                    '</div></div>' +
                    '<div class="rule-days">' + daysHtml + '</div>' +
                    '</div>';
            }).join('');
        }

        function showAddRuleForm() {
            selectedDays = new Set();
            document.getElementById('ruleName').value = '';
            document.getElementById('ruleStartTime').value = '12:00';
            document.getElementById('ruleEndTime').value = '15:30';
            document.getElementById('ruleForm').style.display = 'block';
            renderDaySelector();
        }

        function cancelRuleForm() {
            document.getElementById('ruleForm').style.display = 'none';
        }

        function renderDaySelector() {
            var container = document.getElementById('daySelector');
            container.innerHTML = DAY_NAMES.map(function (d, i) {
                var sel = selectedDays.has(i) ? ' selected' : '';
                return '<button type="button" class="day-btn' + sel + '" onclick="toggleDay(' + i + ')">' + d + '</button>';
            }).join('');
        }

        function toggleDay(i) {
            if (selectedDays.has(i)) selectedDays.delete(i); else selectedDays.add(i);
            renderDaySelector();
        }

        async function saveRule() {
            var name = document.getElementById('ruleName').value.trim();
            var startTime = document.getElementById('ruleStartTime').value;
            var endTime = document.getElementById('ruleEndTime').value;
            var status = document.getElementById('statusSchedule');

            if (!name) { status.textContent = '‚ö†Ô∏è Escribe un nombre'; status.className = 'status show error'; return; }
            if (selectedDays.size === 0) { status.textContent = '‚ö†Ô∏è Selecciona al menos un dia'; status.className = 'status show error'; return; }
            if (!startTime || !endTime) { status.textContent = '‚ö†Ô∏è Indica horario'; status.className = 'status show error'; return; }

            var rule = {
                id: 'rule-' + Date.now(),
                label: name,
                days: Array.from(selectedDays).sort(),
                startTime: startTime,
                endTime: endTime,
                active: true
            };

            currentSchedule.rules = currentSchedule.rules || [];
            currentSchedule.rules.push(rule);

            status.textContent = 'Guardando...';
            status.className = 'status show loading';

            try {
                var res = await fetch('/api/schedule', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pin: '9069', schedule: currentSchedule })
                });
                var data = await res.json();
                if (data.error) throw new Error(data.error);
                status.textContent = '‚úÖ Regla guardada';
                status.className = 'status show success';
                cancelRuleForm();
                renderSchedule();
                setTimeout(function () { status.className = 'status'; }, 2000);
            } catch (e) {
                // Remove the rule we just added since save failed
                currentSchedule.rules.pop();
                status.textContent = '‚ùå Error: ' + e.message;
                status.className = 'status show error';
            }
        }

        async function deleteRule(ruleId) {
            var status = document.getElementById('statusSchedule');
            currentSchedule.rules = currentSchedule.rules.filter(function (r) { return r.id !== ruleId; });

            status.textContent = 'Eliminando...';
            status.className = 'status show loading';

            try {
                var res = await fetch('/api/schedule', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pin: '9069', schedule: currentSchedule })
                });
                var data = await res.json();
                if (data.error) throw new Error(data.error);
                status.textContent = '‚úÖ Regla eliminada';
                status.className = 'status show success';
                renderSchedule();
                setTimeout(function () { status.className = 'status'; }, 2000);
            } catch (e) {
                status.textContent = '‚ùå Error: ' + e.message;
                status.className = 'status show error';
                loadSchedule(); // Reload from server
            }
        }

        async function toggleScheduleEnabled() {
            var status = document.getElementById('statusSchedule');
            currentSchedule.enabled = document.getElementById('scheduleEnabled').checked;

            status.textContent = 'Guardando...';
            status.className = 'status show loading';

            try {
                var res = await fetch('/api/schedule', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pin: '9069', schedule: currentSchedule })
                });
                var data = await res.json();
                if (data.error) throw new Error(data.error);
                status.textContent = '‚úÖ Programacion ' + (currentSchedule.enabled ? 'activada' : 'desactivada');
                status.className = 'status show success';
                renderSchedule();
                setTimeout(function () { status.className = 'status'; }, 2000);
            } catch (e) {
                status.textContent = '‚ùå Error: ' + e.message;
                status.className = 'status show error';
                loadSchedule();
            }
        }

        // ========== MENU TOGGLE ==========
        async function toggleMenu(id, enabled) {
            var status = document.getElementById('statusRest');
            var isCategory = (id === SMART_MENU_CATEGORY.id);
            status.textContent = isCategory ? "Actualizando categor√≠a y men√∫s..." : "Actualizando men√∫...";
            status.className = "status show loading";
            try {
                // Siempre PATCH el item que se toc√≥
                var ids = [id];
                // Si es la categor√≠a padre, tambi√©n PATCH todos los hijos
                if (isCategory) {
                    RESTAURANT_MENUS.forEach(function (m) { ids.push(m.id); });
                }
                // Enviar todos en paralelo
                var promises = ids.map(function (catId) {
                    return fetch('/api/menus', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ categoryId: catId, isEnabled: enabled, name: catId === SMART_MENU_CATEGORY.id ? SMART_MENU_CATEGORY.name : RESTAURANT_MENUS.find(function(x){return x.id===catId}).name })
                    }).then(function (r) { return r.json(); });
                });
                var results = await Promise.all(promises);
                var failed = results.filter(function (r) { return !r.success; });
                if (failed.length === 0) {
                    status.textContent = "‚úÖ " + (isCategory ? "Categor√≠a y men√∫s" : "Men√∫") + (enabled ? " activados" : " desactivados");
                    status.className = "status show success";
                    // Si es categor√≠a, sincronizar toggles hijos
                    if (isCategory) {
                        document.querySelectorAll('#menuList .menu-item input[type=checkbox]').forEach(function (cb) {
                            cb.checked = enabled;
                        });
                    }
                    setTimeout(function () { status.className = "status"; }, 2000);
                } else {
                    throw new Error(failed[0].error);
                }
            } catch (e) {
                status.textContent = "‚ùå Error: " + e.message; status.className = "status show error";
            }
        }
    </script>
</body>

</html>